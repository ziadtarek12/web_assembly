<!DOCTYPE html>
<html>
<head>
  <title>Film Database | WebAssembly</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* Core styles */
    :root {
      --primary-color: #3498db;
      --secondary-color: #2c3e50;
      --accent-color: #e74c3c;
      --text-color: #333;
      --light-bg: #f8f9fa;
      --border-color: #ddd;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      line-height: 1.6;
      color: var(--text-color);
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: var(--secondary-color);
      color: white;
      padding: 1rem;
      position: relative;
    }
    
    h1, h2, h3, h4 {
      margin-top: 0;
      color: var(--secondary-color);
    }
    
    header h1 {
      color: white;
      margin: 0;
    }
    
    /* Navigation */
    nav {
      background-color: var(--secondary-color);
      padding: 0.5rem 1rem;
    }
    
    nav ul {
      list-style-type: none;
      margin: 0;
      padding: 0;
      display: flex;
    }
    
    nav li {
      margin-right: 1rem;
    }
    
    nav a {
      color: white;
      text-decoration: none;
      padding: 0.5rem;
      border-radius: 4px;
      transition: background-color 0.3s;
    }
    
    nav a:hover, nav a.active {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    /* Auth area */
    .auth-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 1rem;
    }
    
    /* Forms */
    .form-group {
      margin-bottom: 1rem;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    input, textarea, select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      font-size: 1rem;
      font-family: inherit;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #2980b9;
    }
    
    button.secondary {
      background-color: #95a5a6;
    }
    
    button.danger {
      background-color: var(--accent-color);
    }
    
    /* Films grid */
    .films-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .film-card {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      position: relative;
    }
    
    .film-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .film-poster {
      height: 300px;
      background-size: cover;
      background-position: center;
      background-color: #ddd;
    }
    
    .film-info {
      padding: 1rem;
    }
    
    .film-title {
      margin: 0 0 0.5rem 0;
      font-size: 1.2rem;
    }
    
    .film-meta {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
    
    .film-genres {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }
    
    .genre-tag {
      font-size: 0.8rem;
      background: #f0f0f0;
      padding: 0.3rem 0.6rem;
      border-radius: 20px;
    }
    
    .film-rating {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: rgba(0,0,0,0.7);
      color: white;
      border-radius: 50%;
      width: 2rem;
      height: 2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* Film detail */
    .film-detail {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 2rem;
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .film-poster-large {
      width: 100%;
      height: auto;
      border-radius: 4px;
    }
    
    .film-detail-info h2 {
      margin-top: 0;
      margin-bottom: 0.5rem;
    }
    
    .film-description {
      margin: 1rem 0;
      line-height: 1.8;
    }
    
    .detail-meta {
      margin: 1rem 0;
      font-size: 0.9rem;
    }
    
    .detail-meta div {
      margin-bottom: 0.5rem;
    }
    
    .detail-meta span {
      font-weight: bold;
    }
    
    .film-actions {
      margin-top: 1rem;
      display: flex;
      gap: 0.5rem;
    }
    
    /* Sections */
    section {
      margin-bottom: 2rem;
    }
    
    /* Filters */
    .filter-bar {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .filter-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
      gap: 0.5rem;
    }
    
    .pagination button {
      min-width: 2rem;
      text-align: center;
    }
    
    /* Modals */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal {
      background: white;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }
    
    /* Status message */
    .status {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
    }
    
    .status.error {
      background-color: #ffebee;
      color: #c62828;
    }
    
    .status.success {
      background-color: #e8f5e9;
      color: #2e7d32;
    }
    
    .status.info {
      background-color: #e3f2fd;
      color: #1565c0;
    }
    
    /* Tabs */
    .tabs {
      margin-bottom: 1rem;
    }
    
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab-button {
      padding: 0.5rem 1rem;
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
    }
    
    .tab-button.active {
      border-bottom: 3px solid var(--primary-color);
      font-weight: bold;
    }
    
    .tab-content {
      display: none;
      padding: 1rem 0;
    }
    
    .tab-content.active {
      display: block;
    }

    /* Responsiveness */
    @media (max-width: 768px) {
      .film-detail {
        grid-template-columns: 1fr;
      }
      
      .auth-controls {
        position: static;
        margin-top: 1rem;
      }
      
      header {
        text-align: center;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Film Database</h1>
    <div class="auth-controls">
      <button id="login-button">Login</button>
      <button id="register-button">Register</button>
      <button id="logout-button" style="display:none;">Logout</button>
    </div>
  </header>
  
  <nav>
    <ul>
      <li><a href="#" id="nav-home" class="active">Home</a></li>
      <li><a href="#" id="nav-films">Films</a></li>
      <li><a href="#" id="nav-admin" style="display:none;">Admin</a></li>
    </ul>
  </nav>
  
  <main class="container">
    <!-- Status message display -->
    <div id="status-message" class="status" style="display:none;"></div>
    
    <!-- Home page -->
    <section id="home-page">
      <h2>Welcome to Film Database</h2>
      <p>Explore our collection of films, read details, and manage your favorites.</p>
      <p>Use the Films section to browse our catalog with advanced filtering and sorting options.</p>
      <p>Login to access personalized features and contribute to the database.</p>
      
      <div class="loading" id="loading-featured">Loading featured films...</div>
      
      <h3>Featured Films</h3>
      <div class="films-grid" id="featured-films">
        <!-- Films will be populated here -->
      </div>
    </section>
    
    <!-- Films page -->
    <section id="films-page" style="display:none;">
      <h2>Films Collection</h2>
      
      <div class="filter-bar">
        <form id="filter-form" class="filter-form">
          <div class="form-group">
            <label for="filter-title">Title</label>
            <input type="text" id="filter-title" placeholder="Search by title">
          </div>
          
          <div class="form-group">
            <label for="filter-genres">Genres</label>
            <input type="text" id="filter-genres" placeholder="E.g. Action, Drama">
          </div>
          
          <div class="form-group">
            <label for="filter-directors">Directors</label>
            <input type="text" id="filter-directors" placeholder="E.g. Nolan, Spielberg">
          </div>
          
          <div class="form-group">
            <label for="filter-actors">Actors</label>
            <input type="text" id="filter-actors" placeholder="E.g. DiCaprio, Hanks">
          </div>
          
          <div class="form-group">
            <label for="filter-sort">Sort By</label>
            <select id="filter-sort">
              <option value="title">Title (A-Z)</option>
              <option value="-title">Title (Z-A)</option>
              <option value="-year">Year (Newest first)</option>
              <option value="year">Year (Oldest first)</option>
              <option value="-rating">Rating (High to Low)</option>
              <option value="rating">Rating (Low to High)</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>&nbsp;</label>
            <button type="submit">Apply Filters</button>
          </div>
        </form>
      </div>
      
      <div class="loading" id="loading-films">Loading films...</div>
      
      <div class="films-grid" id="films-grid">
        <!-- Films will be populated here -->
      </div>
      
      <div class="pagination" id="pagination">
        <!-- Pagination controls will be added here -->
      </div>
    </section>
    
    <!-- Film detail page -->
    <section id="film-detail-page" style="display:none;">
      <button id="back-to-films">← Back to Films</button>
      
      <div class="loading" id="loading-film-detail">Loading film details...</div>
      
      <div class="film-detail" id="film-detail">
        <!-- Film detail will be populated here -->
      </div>
    </section>
    
    <!-- Admin page -->
    <section id="admin-page" style="display:none;">
      <h2>Film Management</h2>
      
      <button id="add-film-button" class="add-film-button">+ Add New Film</button>
      
      <div class="tabs">
        <div class="tab-buttons">
          <button class="tab-button active" data-tab="current-films">Current Films</button>
        </div>
        
        <div id="current-films" class="tab-content active">
          <div class="loading" id="loading-admin-films">Loading films...</div>
          
          <table id="admin-films-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Title</th>
                <th>Year</th>
                <th>Rating</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Films will be populated here -->
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
  
  <!-- Modals -->
  
  <!-- Login Modal -->
  <div class="modal-overlay" id="login-modal">
    <div class="modal">
      <button class="modal-close">&times;</button>
      <h2>Login</h2>
      
      <form id="login-form">
        <div class="form-group">
          <label for="login-email">Email</label>
          <input type="email" id="login-email" required>
        </div>
        
        <div class="form-group">
          <label for="login-password">Password</label>
          <input type="password" id="login-password" required>
        </div>
        
        <button type="submit">Login</button>
      </form>
    </div>
  </div>
  
  <!-- Register Modal -->
  <div class="modal-overlay" id="register-modal">
    <div class="modal">
      <button class="modal-close">&times;</button>
      <h2>Register</h2>
      
      <form id="register-form">
        <div class="form-group">
          <label for="register-name">Name</label>
          <input type="text" id="register-name" required>
        </div>
        
        <div class="form-group">
          <label for="register-email">Email</label>
          <input type="email" id="register-email" required>
        </div>
        
        <div class="form-group">
          <label for="register-password">Password</label>
          <input type="password" id="register-password" required>
        </div>
        
        <button type="submit">Register</button>
      </form>
    </div>
  </div>
  
  <!-- Activation Modal -->
  <div class="modal-overlay" id="activation-modal">
    <div class="modal">
      <button class="modal-close">&times;</button>
      <h2>Activate Account</h2>
      
      <p>Please enter the activation token that was sent to your email.</p>
      
      <form id="activation-form">
        <div class="form-group">
          <label for="activation-token">Activation Token</label>
          <input type="text" id="activation-token" required>
        </div>
        
        <button type="submit">Activate</button>
      </form>
    </div>
  </div>
  
  <!-- Add/Edit Film Modal -->
  <div class="modal-overlay" id="film-form-modal">
    <div class="modal">
      <button class="modal-close">&times;</button>
      <h2 id="film-form-title">Add Film</h2>
      
      <form id="film-form">
        <input type="hidden" id="edit-film-id">
        
        <div class="form-group">
          <label for="film-title">Title</label>
          <input type="text" id="film-title" required>
        </div>
        
        <div class="form-group">
          <label for="film-year">Year</label>
          <input type="number" id="film-year" min="1900" max="2100" required>
        </div>
        
        <div class="form-group">
          <label for="film-runtime">Runtime (minutes)</label>
          <input type="number" id="film-runtime" min="1" required>
        </div>
        
        <div class="form-group">
          <label for="film-rating">Rating (1-10)</label>
          <input type="number" id="film-rating" min="0" max="10" step="0.1" required>
        </div>
        
        <div class="form-group">
          <label for="film-description">Description</label>
          <textarea id="film-description" rows="3" required></textarea>
        </div>
        
        <div class="form-group">
          <label for="film-image">Image URL</label>
          <input type="url" id="film-image" required>
        </div>
        
        <div class="form-group">
          <label for="film-genres">Genres (comma-separated)</label>
          <input type="text" id="film-genres" placeholder="Action, Drama, Sci-Fi" required>
        </div>
        
        <div class="form-group">
          <label for="film-directors">Directors (comma-separated)</label>
          <input type="text" id="film-directors" placeholder="Christopher Nolan, Steven Spielberg" required>
        </div>
        
        <div class="form-group">
          <label for="film-actors">Actors (comma-separated)</label>
          <input type="text" id="film-actors" placeholder="Tom Hanks, Leonardo DiCaprio" required>
        </div>
        
        <button type="submit">Save Film</button>
      </form>
    </div>
  </div>
  
  <!-- Delete Confirmation Modal -->
  <div class="modal-overlay" id="delete-confirm-modal">
    <div class="modal">
      <button class="modal-close">&times;</button>
      <h2>Delete Film</h2>
      
      <p>Are you sure you want to delete this film? This action cannot be undone.</p>
      
      <div class="film-actions">
        <button id="confirm-delete" class="danger">Yes, Delete</button>
        <button id="cancel-delete" class="secondary">Cancel</button>
      </div>
    </div>
  </div>
  
  <script src="wasm_exec.js"></script>
  <script>
    // WebAssembly initialization
    const go = new Go();
    let wasmLoaded = false;
    
    // API Configuration
    const API_BASE_URL = "https://api.filmapi.example.com/v1"; // Replace with your actual API URL
    let currentUser = null;
    let currentFilms = [];
    let currentPage = 1;
    let totalPages = 1;
    let pageSize = 20;
    let filmToDelete = null;
    
    // Initialize WebAssembly
    WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject)
      .then((result) => {
        go.run(result.instance);
        wasmLoaded = true;
        setAPIBaseURL(API_BASE_URL);
        initApp();
      })
      .catch(err => {
        showStatusMessage('error', 'Failed to load WebAssembly: ' + err.message);
        console.error('Failed to load WASM:', err);
      });
    
    // Initialize application
    function initApp() {
      // Check authentication status and update UI
      updateAuthUI();
      
      // Load initial data
      loadFeaturedFilms();
      
      // Set up event listeners
      setupEventListeners();
    }
    
    // Set up event listeners
    function setupEventListeners() {
      // Navigation
      document.getElementById('nav-home').addEventListener('click', (e) => {
        e.preventDefault();
        showPage('home-page');
      });
      
      document.getElementById('nav-films').addEventListener('click', (e) => {
        e.preventDefault();
        showPage('films-page');
        loadFilms();
      });
      
      document.getElementById('nav-admin').addEventListener('click', (e) => {
        e.preventDefault();
        showPage('admin-page');
        loadAdminFilms();
      });
      
      // Auth buttons
      document.getElementById('login-button').addEventListener('click', () => {
        showModal('login-modal');
      });
      
      document.getElementById('register-button').addEventListener('click', () => {
        showModal('register-modal');
      });
      
      document.getElementById('logout-button').addEventListener('click', () => {
        logout();
        updateAuthUI();
        showStatusMessage('info', 'You have been logged out.');
        showPage('home-page');
      });
      
      // Back button
      document.getElementById('back-to-films').addEventListener('click', () => {
        showPage('films-page');
      });
      
      // Add film button
      document.getElementById('add-film-button').addEventListener('click', () => {
        document.getElementById('film-form').reset();
        document.getElementById('edit-film-id').value = '';
        document.getElementById('film-form-title').textContent = 'Add Film';
        showModal('film-form-modal');
      });
      
      // Modal close buttons
      document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', () => {
          closeAllModals();
        });
      });
      
      // Forms
      document.getElementById('login-form').addEventListener('submit', handleLogin);
      document.getElementById('register-form').addEventListener('submit', handleRegister);
      document.getElementById('activation-form').addEventListener('submit', handleActivation);
      document.getElementById('film-form').addEventListener('submit', handleFilmSubmit);
      document.getElementById('filter-form').addEventListener('submit', handleFilterSubmit);
      
      // Delete confirmation
      document.getElementById('confirm-delete').addEventListener('click', confirmDeleteFilm);
      document.getElementById('cancel-delete').addEventListener('click', () => {
        closeModal('delete-confirm-modal');
        filmToDelete = null;
      });
    }
    
    // Show a specific page
    function showPage(pageId) {
      // Hide all pages
      document.getElementById('home-page').style.display = 'none';
      document.getElementById('films-page').style.display = 'none';
      document.getElementById('film-detail-page').style.display = 'none';
      document.getElementById('admin-page').style.display = 'none';
      
      // Remove active class from all nav links
      document.querySelectorAll('nav a').forEach(link => {
        link.classList.remove('active');
      });
      
      // Show requested page and activate nav link
      document.getElementById(pageId).style.display = 'block';
      
      // Update active nav link
      if (pageId === 'home-page') {
        document.getElementById('nav-home').classList.add('active');
      } else if (pageId === 'films-page') {
        document.getElementById('nav-films').classList.add('active');
      } else if (pageId === 'admin-page') {
        document.getElementById('nav-admin').classList.add('active');
      }
    }
    
    // Show a modal
    function showModal(modalId) {
      closeAllModals();
      document.getElementById(modalId).style.display = 'flex';
    }
    
    // Close a specific modal
    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
    }
    
    // Close all modals
    function closeAllModals() {
      document.querySelectorAll('.modal-overlay').forEach(modal => {
        modal.style.display = 'none';
      });
    }
    
    // Show status message
    function showStatusMessage(type, message) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.className = `status ${type}`;
      statusDiv.textContent = message;
      statusDiv.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 5000);
    }
    
    // Update authentication UI
    function updateAuthUI() {
      const isAuth = isAuthenticated();
      
      document.getElementById('login-button').style.display = isAuth ? 'none' : 'inline-block';
      document.getElementById('register-button').style.display = isAuth ? 'none' : 'inline-block';
      document.getElementById('logout-button').style.display = isAuth ? 'inline-block' : 'none';
      document.getElementById('nav-admin').style.display = isAuth ? 'inline-block' : 'none';
    }
    
    // Handle login form submission
    function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      
      try {
        const result = login(email, password);
        
        if (result.success) {
          closeAllModals();
          updateAuthUI();
          showStatusMessage('success', 'Login successful!');
        } else {
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        showStatusMessage('error', 'Login failed: ' + err.message);
      }
    }
    
    // Handle registration form submission
    function handleRegister(e) {
      e.preventDefault();
      
      const name = document.getElementById('register-name').value;
      const email = document.getElementById('register-email').value;
      const password = document.getElementById('register-password').value;
      
      try {
        const result = registerUser(name, email, password);
        
        if (result.success) {
          closeModal('register-modal');
          showModal('activation-modal');
          showStatusMessage('success', 'Registration successful! Please check your email for activation token.');
        } else {
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        showStatusMessage('error', 'Registration failed: ' + err.message);
      }
    }
    
    // Handle account activation
    function handleActivation(e) {
      e.preventDefault();
      
      const token = document.getElementById('activation-token').value;
      
      try {
        const result = activateUser(token);
        
        if (result.success) {
          closeAllModals();
          showStatusMessage('success', 'Account activated successfully! You can now log in.');
        } else {
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        showStatusMessage('error', 'Activation failed: ' + err.message);
      }
    }
    
    // Load featured films
    function loadFeaturedFilms() {
      if (!wasmLoaded) return;
      
      document.getElementById('loading-featured').style.display = 'block';
      
      try {
        // Get a small set of films sorted by rating
        const filters = { page: 1, page_size: 4, sort: "-rating" };
        const result = getFilms(filters);
        
        if (result.success) {
          renderFilmsGrid(result.data.films, 'featured-films');
          document.getElementById('loading-featured').style.display = 'none';
        } else {
          document.getElementById('loading-featured').style.display = 'none';
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        document.getElementById('loading-featured').style.display = 'none';
        showStatusMessage('error', 'Failed to load featured films: ' + err.message);
      }
    }
    
    // Load films with pagination and filtering
    function loadFilms() {
      if (!wasmLoaded) return;
      
      document.getElementById('loading-films').style.display = 'block';
      
      try {
        // Get filter values from form
        const title = document.getElementById('filter-title').value;
        const genres = document.getElementById('filter-genres').value;
        const directors = document.getElementById('filter-directors').value;
        const actors = document.getElementById('filter-actors').value;
        const sort = document.getElementById('filter-sort').value;
        
        const filters = {
          page: currentPage,
          page_size: pageSize,
          sort: sort
        };
        
        if (title) filters.title = title;
        if (genres) filters.genres = genres;
        if (directors) filters.directors = directors;
        if (actors) filters.actors = actors;
        
        const result = getFilms(filters);
        
        if (result.success) {
          currentFilms = result.data.films || [];
          const metadata = result.data.metadata || {};
          
          renderFilmsGrid(currentFilms, 'films-grid');
          renderPagination(metadata);
          
          document.getElementById('loading-films').style.display = 'none';
        } else {
          document.getElementById('loading-films').style.display = 'none';
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        document.getElementById('loading-films').style.display = 'none';
        showStatusMessage('error', 'Failed to load films: ' + err.message);
      }
    }
    
    // Load admin films
    function loadAdminFilms() {
      if (!wasmLoaded || !isAuthenticated()) return;
      
      document.getElementById('loading-admin-films').style.display = 'block';
      
      try {
        const result = getFilms({});
        
        if (result.success) {
          const films = result.data.films || [];
          renderAdminFilmsTable(films);
          document.getElementById('loading-admin-films').style.display = 'none';
        } else {
          document.getElementById('loading-admin-films').style.display = 'none';
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        document.getElementById('loading-admin-films').style.display = 'none';
        showStatusMessage('error', 'Failed to load admin films: ' + err.message);
      }
    }
    
    // Load film details
    function loadFilmDetails(id) {
      if (!wasmLoaded) return;
      
      document.getElementById('loading-film-detail').style.display = 'block';
      document.getElementById('film-detail').style.display = 'none';
      showPage('film-detail-page');
      
      try {
        const result = getFilmByID(id);
        
        if (result.success) {
          const film = result.data.film;
          renderFilmDetail(film);
          document.getElementById('loading-film-detail').style.display = 'none';
          document.getElementById('film-detail').style.display = 'grid';
        } else {
          document.getElementById('loading-film-detail').style.display = 'none';
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        document.getElementById('loading-film-detail').style.display = 'none';
        showStatusMessage('error', 'Failed to load film details: ' + err.message);
      }
    }
    
    // Render films grid
    function renderFilmsGrid(films, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      
      if (!films || films.length === 0) {
        container.innerHTML = '<p>No films found. Try different filters or add some films.</p>';
        return;
      }
      
      films.forEach(film => {
        const card = document.createElement('div');
        card.className = 'film-card';
        card.dataset.id = film.id;
        
        // Create film poster
        const poster = document.createElement('div');
        poster.className = 'film-poster';
        poster.style.backgroundImage = `url(${film.image || 'https://via.placeholder.com/300x450?text=No+Image'})`;
        
        // Create rating badge
        const rating = document.createElement('div');
        rating.className = 'film-rating';
        rating.textContent = film.rating;
        
        // Create film info
        const info = document.createElement('div');
        info.className = 'film-info';
        
        const title = document.createElement('h3');
        title.className = 'film-title';
        title.textContent = film.title;
        
        const meta = document.createElement('div');
        meta.className = 'film-meta';
        meta.textContent = `${film.year} • ${film.runtime}`;
        
        const genres = document.createElement('div');
        genres.className = 'film-genres';
        
        if (film.genres && film.genres.length) {
          film.genres.slice(0, 3).forEach(genre => {
            const tag = document.createElement('span');
            tag.className = 'genre-tag';
            tag.textContent = genre;
            genres.appendChild(tag);
          });
        }
        
        // Append elements
        info.appendChild(title);
        info.appendChild(meta);
        info.appendChild(genres);
        
        card.appendChild(poster);
        card.appendChild(rating);
        card.appendChild(info);
        
        // Add click event
        card.addEventListener('click', () => {
          loadFilmDetails(film.id);
        });
        
        container.appendChild(card);
      });
    }
    
    // Render film detail
    function renderFilmDetail(film) {
      if (!film) {
        document.getElementById('film-detail').innerHTML = '<p>Film not found.</p>';
        return;
      }
      
      const detailContainer = document.getElementById('film-detail');
      
      // Create left column with poster
      const leftColumn = document.createElement('div');
      leftColumn.className = 'film-detail-poster';
      
      const poster = document.createElement('img');
      poster.className = 'film-poster-large';
      poster.src = film.image || 'https://via.placeholder.com/300x450?text=No+Image';
      poster.alt = film.title;
      
      leftColumn.appendChild(poster);
      
      // Create right column with info
      const rightColumn = document.createElement('div');
      rightColumn.className = 'film-detail-info';
      
      // Title and year
      const title = document.createElement('h2');
      title.textContent = `${film.title} (${film.year})`;
      
      // Rating
      const rating = document.createElement('div');
      rating.className = 'film-rating-large';
      rating.textContent = `Rating: ${film.rating}/10`;
      
      // Description
      const description = document.createElement('div');
      description.className = 'film-description';
      description.textContent = film.description;
      
      // Meta info
      const meta = document.createElement('div');
      meta.className = 'detail-meta';
      
      const runtime = document.createElement('div');
      runtime.innerHTML = `<span>Runtime:</span> ${film.runtime}`;
      
      const genres = document.createElement('div');
      genres.innerHTML = `<span>Genres:</span> ${film.genres.join(', ')}`;
      
      const directors = document.createElement('div');
      directors.innerHTML = `<span>Director(s):</span> ${film.directors.join(', ')}`;
      
      const actors = document.createElement('div');
      actors.innerHTML = `<span>Actors:</span> ${film.actors.join(', ')}`;
      
      meta.appendChild(runtime);
      meta.appendChild(genres);
      meta.appendChild(directors);
      meta.appendChild(actors);
      
      // Actions
      let filmActions = null;
      if (isAuthenticated()) {
        filmActions = document.createElement('div');
        filmActions.className = 'film-actions';
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit Film';
        editBtn.addEventListener('click', () => {
          openEditFilmForm(film);
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete Film';
        deleteBtn.className = 'danger';
        deleteBtn.addEventListener('click', () => {
          filmToDelete = film.id;
          showModal('delete-confirm-modal');
        });
        
        filmActions.appendChild(editBtn);
        filmActions.appendChild(deleteBtn);
      }
      
      // Append all elements
      rightColumn.appendChild(title);
      rightColumn.appendChild(rating);
      rightColumn.appendChild(description);
      rightColumn.appendChild(meta);
      if (filmActions) {
        rightColumn.appendChild(filmActions);
      }
      
      // Clear and append to container
      detailContainer.innerHTML = '';
      detailContainer.appendChild(leftColumn);
      detailContainer.appendChild(rightColumn);
    }
    
    // Render admin films table
    function renderAdminFilmsTable(films) {
      const tableBody = document.querySelector('#admin-films-table tbody');
      tableBody.innerHTML = '';
      
      if (!films || films.length === 0) {
        const row = document.createElement('tr');
        const cell = document.createElement('td');
        cell.colSpan = 5;
        cell.textContent = 'No films found.';
        cell.style.textAlign = 'center';
        row.appendChild(cell);
        tableBody.appendChild(row);
        return;
      }
      
      films.forEach(film => {
        const row = document.createElement('tr');
        
        // ID cell
        const idCell = document.createElement('td');
        idCell.textContent = film.id;
        
        // Title cell
        const titleCell = document.createElement('td');
        titleCell.textContent = film.title;
        
        // Year cell
        const yearCell = document.createElement('td');
        yearCell.textContent = film.year;
        
        // Rating cell
        const ratingCell = document.createElement('td');
        ratingCell.textContent = film.rating;
        
        // Actions cell
        const actionsCell = document.createElement('td');
        
        const viewBtn = document.createElement('button');
        viewBtn.textContent = 'View';
        viewBtn.style.marginRight = '5px';
        viewBtn.addEventListener('click', () => {
          loadFilmDetails(film.id);
        });
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'Edit';
        editBtn.style.marginRight = '5px';
        editBtn.addEventListener('click', () => {
          openEditFilmForm(film);
        });
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.className = 'danger';
        deleteBtn.addEventListener('click', () => {
          filmToDelete = film.id;
          showModal('delete-confirm-modal');
        });
        
        actionsCell.appendChild(viewBtn);
        actionsCell.appendChild(editBtn);
        actionsCell.appendChild(deleteBtn);
        
        // Append cells to row
        row.appendChild(idCell);
        row.appendChild(titleCell);
        row.appendChild(yearCell);
        row.appendChild(ratingCell);
        row.appendChild(actionsCell);
        
        tableBody.appendChild(row);
      });
    }
    
    // Render pagination
    function renderPagination(metadata) {
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      
      if (!metadata) return;
      
      totalPages = metadata.last_page || 1;
      currentPage = metadata.current_page || 1;
      
      // Previous button
      const prevButton = document.createElement('button');
      prevButton.textContent = '←';
      prevButton.disabled = currentPage === 1;
      prevButton.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          loadFilms();
        }
      });
      
      // Next button
      const nextButton = document.createElement('button');
      nextButton.textContent = '→';
      nextButton.disabled = currentPage === totalPages;
      nextButton.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          loadFilms();
        }
      });
      
      // Page info
      const pageInfo = document.createElement('span');
      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      pageInfo.style.margin = '0 10px';
      
      pagination.appendChild(prevButton);
      pagination.appendChild(pageInfo);
      pagination.appendChild(nextButton);
    }
    
    // Open edit film form
    function openEditFilmForm(film) {
      document.getElementById('film-form-title').textContent = 'Edit Film';
      document.getElementById('edit-film-id').value = film.id;
      
      document.getElementById('film-title').value = film.title;
      document.getElementById('film-year').value = film.year;
      document.getElementById('film-runtime').value = parseInt(film.runtime);
      document.getElementById('film-rating').value = film.rating;
      document.getElementById('film-description').value = film.description;
      document.getElementById('film-image').value = film.image;
      document.getElementById('film-genres').value = film.genres.join(', ');
      document.getElementById('film-directors').value = film.directors.join(', ');
      document.getElementById('film-actors').value = film.actors.join(', ');
      
      showModal('film-form-modal');
    }
    
    // Handle film form submission (create or update)
    function handleFilmSubmit(e) {
      e.preventDefault();
      
      if (!isAuthenticated()) {
        showStatusMessage('error', 'You must be logged in to perform this action.');
        return;
      }
      
      const filmId = document.getElementById('edit-film-id').value;
      const isEditing = !!filmId;
      
      // Parse form data
      const filmData = {
        title: document.getElementById('film-title').value,
        year: parseInt(document.getElementById('film-year').value),
        runtime: parseInt(document.getElementById('film-runtime').value),
        rating: parseFloat(document.getElementById('film-rating').value),
        description: document.getElementById('film-description').value,
        image: document.getElementById('film-image').value,
        genres: document.getElementById('film-genres').value.split(',').map(g => g.trim()).filter(g => g),
        directors: document.getElementById('film-directors').value.split(',').map(d => d.trim()).filter(d => d),
        actors: document.getElementById('film-actors').value.split(',').map(a => a.trim()).filter(a => a)
      };
      
      try {
        let result;
        
        if (isEditing) {
          result = updateFilm(filmId, filmData);
        } else {
          result = createFilm(filmData);
        }
        
        if (result.success) {
          closeAllModals();
          showStatusMessage('success', `Film ${isEditing ? 'updated' : 'created'} successfully!`);
          
          // Reload films in the current view
          if (document.getElementById('films-page').style.display === 'block') {
            loadFilms();
          } else if (document.getElementById('admin-page').style.display === 'block') {
            loadAdminFilms();
          } else if (document.getElementById('film-detail-page').style.display === 'block' && isEditing) {
            loadFilmDetails(filmId);
          } else {
            // If on home page, reload featured films
            loadFeaturedFilms();
          }
        } else {
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        showStatusMessage('error', `Failed to ${isEditing ? 'update' : 'create'} film: ${err.message}`);
      }
    }
    
    // Handle filter form submission
    function handleFilterSubmit(e) {
      e.preventDefault();
      currentPage = 1; // Reset to first page when filtering
      loadFilms();
    }
    
    // Confirm film deletion
    function confirmDeleteFilm() {
      if (!filmToDelete || !isAuthenticated()) {
        closeModal('delete-confirm-modal');
        return;
      }
      
      try {
        const result = deleteFilm(filmToDelete);
        
        if (result.success) {
          closeModal('delete-confirm-modal');
          showStatusMessage('success', 'Film deleted successfully!');
          
          // Reload films in the current view
          if (document.getElementById('films-page').style.display === 'block') {
            loadFilms();
          } else if (document.getElementById('admin-page').style.display === 'block') {
            loadAdminFilms();
          } else if (document.getElementById('film-detail-page').style.display === 'block') {
            showPage('films-page');
            loadFilms();
          } else {
            // If on home page, reload featured films
            loadFeaturedFilms();
          }
        } else {
          showStatusMessage('error', result.error);
        }
      } catch (err) {
        showStatusMessage('error', 'Failed to delete film: ' + err.message);
      } finally {
        filmToDelete = null;
      }
    }
  </script>
</body>
</html>
